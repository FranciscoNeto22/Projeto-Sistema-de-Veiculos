<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AutoGate - Controle de Ve√≠culos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- === ADICIONADO: Estilos para o indicador de rede === -->
    <style>
        #status-rede.online #bolinha-status {
            color: #00cc44;  /* verde vivo - conectado */
        }
        #status-rede.offline #bolinha-status {
            color: #ff3333;  /* vermelho - desconectado */
        }
        #status-rede {
            font-weight: 500;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #data-hora-atual {
            font-family: monospace;
            font-weight: bold;
            color: #ffffffcc;
            white-space: nowrap;
        }
        /* Sidebar menu ‚Äî negrito e fonte um pouco maior */
        .col-md-2 .nav-link {
            font-weight: 700;
            font-size: 1.05rem;
        }
        /* Mais cor no sidebar */
        .col-md-2.bg-light {
            background-color: #e9f4ff !important; /* azul claro suave */
            border-right: 1px solid #d6e6ff;
        }
        .col-md-2 h5 {
            color: #000000; /* preto para o t√≠tulo */
            font-weight: 700;
        }
        .col-md-2 .nav-link {
            color: #000000; /* preto para os links */
        }
        .col-md-2 .nav-link:hover {
            background-color: rgba(0,0,0,0.1);
            color: #000000;
            border-radius: 4px;
        }
        /* Rodap√© fixo discreto */
        #site-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f5f6f7; /* cinza suave que combina com branco */
            border-top: 1px solid #e0e0e0;
            padding: 10px 0;
            z-index: 1030;
        }
        #site-footer .footer-text {
            color: #6b6f73; /* cinza escuro leve */
            font-size: 0.9rem;
            font-weight: 700;
        }
        /* Espa√ßo inferior para evitar sobreposi√ß√£o do conte√∫do */
        body {
            padding-bottom: 56px;
            background-color: #ffffff;
        }
    </style>
    <!-- Fim dos estilos adicionados -->
</head>

<body>

<!-- HEADER -->
<nav class="navbar navbar-dark bg-dark px-3">
    <button class="btn btn-outline-light d-md-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">‚ò∞</button>
    <span class="navbar-brand mb-0 h1">üöó AutoGate</span>
    
    <!--Indicador de rede-->
    <div id="status-rede" class="text-white">
        <span>Rede</span>
        <span id="bolinha-status" style="font-size: 1.6rem; line-height: 1;">‚Ä¢</span>
        <span id="data-hora-atual" class="ms-2"></span>
    </div>
    <!-- Fim do indicador -->
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- SIDEBAR (vis√≠vel em md+, para telas pequenas usamos offcanvas) -->
        <div class="col-md-2 bg-light vh-100 p-3 d-none d-md-block">
            <h5>Menu</h5>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#">Dashboard</a>
                </li>
                <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#entradaModal">Entrada</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Sa√≠da</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Cadastros</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Relat√≥rios</a>
                </li>
            </ul>
        </div>

        <!-- Offcanvas para telas pequenas -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#entradaModal">Entrada</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Sa√≠da</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Cadastros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Relat√≥rios</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- CONTE√öDO PRINCIPAL -->
        <div class="col-md-10 p-4">

            <!-- CARDS DE RESUMO (sem altera√ß√£o) -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-bg-success">
                        <div class="card-body">
                            <h6>No P√°tio</h6>
                            <h4>12</h4>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card text-bg-danger">
                        <div class="card-body">
                            <h6>Sa√≠ram Hoje</h6>
                            <h4>5</h4>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card text-bg-warning">
                        <div class="card-body">
                            <h6>Pendentes</h6>
                            <h4>2</h4>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card text-bg-info">
                        <div class="card-body">
                            <h6>Visitantes</h6>
                            <h4>3</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABELA -->
            <div class="card">
                <!-- === ALTERADO: Adicionada data e hora no header === -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Lista de Ve√≠culos</span>

                </div>
                <!-- Fim da altera√ß√£o -->

                <div class="card-body">
                    <table class="table table-striped" id="tabela-veiculos">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Respons√°vel</th>
                                <th>Entrada</th>
                                <th>Status</th>
                                <th>P√°tio</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-veiculos">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- === ADICIONADO: Scripts no final do body === -->
<script>
    // 1. Status da Rede (verde = online, vermelho = offline)
    const statusRede = document.getElementById('status-rede');
    const bolinha = document.getElementById('bolinha-status');

    function atualizarStatusRede() {
        if (navigator.onLine) {
            statusRede.classList.remove('offline');
            statusRede.classList.add('online');
        } else {
            statusRede.classList.remove('online');
            statusRede.classList.add('offline');
        }
    }

    atualizarStatusRede();
    window.addEventListener('online', atualizarStatusRede);
    window.addEventListener('offline', atualizarStatusRede);

    // Verifica√ß√£o mais confi√°vel (ping simples a cada 10s)
    setInterval(() => {
        fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-store' })
            .then(() => atualizarStatusRede())
            .catch(() => atualizarStatusRede());
    }, 10000);

    // 2. Data e hora no navbar (atualiza a cada segundo)
    const dataHoraEl = document.getElementById('data-hora-atual');
    function atualizarDataHora() {
        const now = new Date();
        const data = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        if (dataHoraEl) dataHoraEl.textContent = `${data} ${hora}`;
    }
    atualizarDataHora();
    setInterval(atualizarDataHora, 1000);

    // 3. Buscar ve√≠culos da API e atualizar tabela
    async function carregarVeiculos() {
        try {
            console.log('Carregando ve√≠culos...');
            const response = await fetch('http://localhost:5500/veiculos');
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const veiculos = await response.json();
            console.log('Ve√≠culos recebidos:', veiculos);
            
            const tbody = document.getElementById('tbody-veiculos');
            if (!tbody) {
                console.error('Elemento tbody n√£o encontrado!');
                return;
            }
            
            tbody.innerHTML = ''; // Limpar tabela
            
            if (!Array.isArray(veiculos) || veiculos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum ve√≠culo no estacionamento</td></tr>';
            } else {
                veiculos.forEach(veiculo => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${veiculo.placa || '-'}</td>
                        <td>-</td>
                        <td>${veiculo.entrada || '-'}</td>
                        <td><span class="badge bg-success">No P√°tio</span></td>
                        <td>Principal</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="registrarSaida('${veiculo.placa}')">Dar Sa√≠da</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Atualizar card "No P√°tio"
            const cards = document.querySelectorAll('.card.text-bg-success h4');
            if (cards.length > 0) {
                    cards[0].textContent = Array.isArray(veiculos) ? veiculos.length : 0;
                    // Buscar estat√≠sticas adicionais
                    try {
                        fetch('http://localhost:5500/estatisticas')
                            .then(r => r.ok ? r.json() : Promise.reject(r))
                            .then(stats => {
                                if (cards[1]) cards[1].textContent = stats.sairam_hoje ?? '0';
                                if (cards[2]) cards[2].textContent = stats.pendentes ?? '0';
                                if (cards[3]) cards[3].textContent = stats.visitantes ?? '0';
                            })
                            .catch(err => console.error('Erro ao obter estat√≠sticas:', err));
                    } catch (e) {
                        console.error('Erro fetch estatisticas:', e);
                    }
            }
            
        } catch (error) {
            console.error('Erro ao carregar ve√≠culos:', error);
            const tbody = document.getElementById('tbody-veiculos');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">‚ùå Erro ao conectar com a API: ' + error.message + '</td></tr>';
            }
        }
    }

    // 4. Registrar sa√≠da de ve√≠culo
    async function registrarSaida(placa) {
        try {
            console.log('Registrando sa√≠da:', placa);
            const response = await fetch(`http://localhost:5500/saida?placa=${placa}`, { method: 'POST' });
            const resultado = await response.json();
            
            console.log('Resultado sa√≠da:', resultado);
            
            if (resultado.status) {
                alert(`Sa√≠da registrada para ${placa}`);
                carregarVeiculos(); // Recarregar tabela
            } else {
                alert(`Erro: ${resultado.erro}`);
            }
        } catch (error) {
            console.error('Erro ao registrar sa√≠da:', error);
            alert('Erro ao registrar sa√≠da');
        }
    }

    // Carregar ve√≠culos ao iniciar a p√°gina
    window.addEventListener('load', () => {
        console.log('P√°gina carregada, iniciando carregamento de ve√≠culos');
        carregarVeiculos();
    });

    // Atualizar ve√≠culos a cada 5 segundos
    setInterval(carregarVeiculos, 5000);
</script>
<!-- Fim dos scripts -->

<!-- Bootstrap JS (necess√°rio para offcanvas e comportamento responsivo) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Modal: Entradas de Carros -->
<div class="modal fade" id="entradaModal" tabindex="-1" aria-labelledby="entradaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius:14px; overflow:hidden;">
            <div class="modal-header">
                <h5 class="modal-title" id="entradaModalLabel">Entradas - Carros</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="entradaModalBody">
                    <p class="text-muted">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Preenche o modal quando for exibido
document.getElementById('entradaModal').addEventListener('show.bs.modal', async function (event) {
        const body = document.getElementById('entradaModalBody');
        body.innerHTML = '<p class="text-muted">Carregando...</p>';
        try {
                const res = await fetch('http://localhost:5500/veiculos');
                if (!res.ok) throw new Error('Erro HTTP ' + res.status);
                const veiculos = await res.json();

                // Filtrar apenas carros (tipo cont√©m 'carro' ou == 'carro')
                const carros = (Array.isArray(veiculos) ? veiculos : []).filter(v => {
                    if (!v.tipo) return false;
                    return v.tipo.toString().toLowerCase().includes('carro');
                });

                if (carros.length === 0) {
                    body.innerHTML = '<div class="text-center text-muted">Nenhum carro no estacionamento</div>';
                    return;
                }

                // Construir lista √∫nica de nomes de respons√°veis
                const nomes = [];
                carros.forEach(c => {
                    const responsavel = (c.responsavel || c.responsavelNome || '').toString().trim();
                    if (responsavel) nomes.push(responsavel);
                });

                // remover duplicados
                const nomesUnicos = Array.from(new Set(nomes));

                if (nomesUnicos.length === 0) {
                    body.innerHTML = '<div class="text-center text-muted">Nenhum respons√°vel registrado</div>';
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'list-group';
                nomesUnicos.forEach(n => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = n;
                    ul.appendChild(li);
                });

                body.innerHTML = '';
                body.appendChild(ul);
        } catch (err) {
                body.innerHTML = '<div class="text-danger">Erro ao carregar entradas: ' + (err.message || err) + '</div>';
                console.error(err);
        }
});
</script>


<!-- Rodap√© fixo -->
<footer id="site-footer">
    <div class="container-fluid text-start px-0">
        <span class="footer-text">Desenvolvido por: CisNet Tech</span>
    </div>
</footer>

</body>
</html>